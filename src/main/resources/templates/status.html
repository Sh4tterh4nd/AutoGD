<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <meta charset="UTF-8">
    <title>AutoGD</title>
    <script src="/js/sockjs.js"></script>
    <script src="/js/stomp.js"></script>
</head>
<body>

<th:block layout:fragment="content">
    <div>
        <div>
            <input type="text" id="from" placeholder="Choose a nickname"/>
        </div>
        <br/>
        <div>
            <button id="connect" onclick="connect();">Connect</button>
            <button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
        </div>
        <br/>
        <div id="conversationDiv">
            <input type="text" id="text" placeholder="Write a message..."/>
            <button id="sendMessage" onclick="sendMessage();">Send</button>
            <p id="response"></p>
        </div>
    </div>


    <script type="text/javascript">

        var stompClient = null;

        function setConnected(connected) {

            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;
            document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
            document.getElementById('response').innerHTML = '';
        }

        function connect() {

            var socket = new SockJS('/chat');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {

                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/message', function (messageOutput) {
                    let msg = JSON.parse(messageOutput.body);
                    appendLog(msg.time + ': ' + msg.text);
                });

            });
        }

        // function disconnect() {
        //
        //     if (stompClient != null) {
        //         stompClient.disconnect();
        //     }
        //
        //     setConnected(false);
        //     console.log("Disconnected");
        // }

        function sendMessage() {

            var from = document.getElementById('from').value;
            var text = document.getElementById('text').value;
            stompClient.send("/app/chat", {}, JSON.stringify({'from': from, 'text': text}));
        }

        function showMessageOutput(messageOutput) {

            var response = document.getElementById('response');
            var p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(messageOutput.from + ": " + messageOutput.text + " (" + messageOutput.time + ")"));
            response.appendChild(p);
        }

        onload(connect());

    </script>

    <div id="logView" style="
      width: 100%;
      height: 500px;
      background-color: #1e1e1e;
      color: #dcdcdc;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #333;
      overflow-y: scroll;
      white-space: pre-wrap;
    "></div>

    <script>
        // Example of adding log lines dynamically
        const logView = document.getElementById('logView');

        function appendLog(message) {
            logView.textContent += message + '\n';
            logView.scrollTop = logView.scrollHeight; // Auto-scroll to bottom
        }

        // Example usage
        appendLog('Log initialized...');
        appendLog('New message logged.');
    </script>


</th:block>
</body>
</html>